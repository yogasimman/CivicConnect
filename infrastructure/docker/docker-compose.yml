# =============================================================================
# Civic Connect – Docker Compose (Production-Ready)
# =============================================================================
# Architecture:
#   Each service has its OWN isolated network + connects to infra-net
#   to reach databases. NGINX reverse-proxy bridges all service networks.
#
# Networks:
#   infra-net        → PostgreSQL, RabbitMQ, MinIO, Redis
#   admin-net        → admin-service isolation
#   content-net      → content-service isolation
#   complaint-net    → complaint-service isolation
#   ai-net           → ai-worker isolation
#   chatbot-net      → chatbot-service isolation
#   frontend-net     → admin-panel + nginx gateway
# =============================================================================

services:

  # ═══════════════════════════════════════════════════════════════════════════
  # INFRASTRUCTURE LAYER
  # ═══════════════════════════════════════════════════════════════════════════

  postgres:
    image: postgis/postgis:16-3.4
    container_name: civic-postgres
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    networks:
      - infra-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  rabbitmq:
    image: rabbitmq:3-management
    container_name: civic-rabbitmq
    restart: unless-stopped
    env_file: .env
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "${RABBITMQ_MGMT_PORT}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - infra-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s

  minio:
    image: minio/minio
    container_name: civic-minio
    restart: unless-stopped
    env_file: .env
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_PORT}:9000"
      - "${MINIO_CONSOLE_PORT}:9001"
    volumes:
      - minio_data:/data
    networks:
      - infra-net
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 20s

  redis:
    image: redis:alpine
    container_name: civic-redis
    restart: unless-stopped
    env_file: .env
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - redis_data:/data
    networks:
      - infra-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # BACKEND SERVICES
  # ═══════════════════════════════════════════════════════════════════════════

  admin-service:
    build:
      context: ../../admin-service
      dockerfile: Dockerfile
    container_name: civic-admin-service
    restart: unless-stopped
    env_file: .env
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: admin_db
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRY: ${JWT_EXPIRY}
      PORT: ${ADMIN_SERVICE_PORT}
    ports:
      - "${ADMIN_SERVICE_PORT}:${ADMIN_SERVICE_PORT}"
    networks:
      - infra-net
      - admin-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${ADMIN_SERVICE_PORT}/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  content-service:
    build:
      context: ../..
      dockerfile: content-service/Dockerfile
    container_name: civic-content-service
    restart: unless-stopped
    env_file: .env
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: content_db
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      PORT: ${CONTENT_SERVICE_PORT}
      GRPC_PORT: ${GRPC_PORT}
    ports:
      - "${CONTENT_SERVICE_PORT}:${CONTENT_SERVICE_PORT}"
      - "${GRPC_PORT}:${GRPC_PORT}"
    networks:
      - infra-net
      - content-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${CONTENT_SERVICE_PORT}/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  complaint-service:
    build:
      context: ../../complaint-service
      dockerfile: Dockerfile
    container_name: civic-complaint-service
    restart: unless-stopped
    env_file: .env
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: complaint_db
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: ${MINIO_BUCKET}
      PORT: ${COMPLAINT_SERVICE_PORT}
    ports:
      - "${COMPLAINT_SERVICE_PORT}:${COMPLAINT_SERVICE_PORT}"
    networks:
      - infra-net
      - complaint-net
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${COMPLAINT_SERVICE_PORT}/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  ai-worker:
    build:
      context: ../..
      dockerfile: ai-worker/Dockerfile
    container_name: civic-ai-worker
    restart: unless-stopped
    env_file: .env
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      CONTENT_SERVICE_GRPC: content-service:${GRPC_PORT}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL}
      AI_GRPC_PORT: ${AI_GRPC_PORT}
      PORT: ${AI_WORKER_PORT}
    ports:
      - "${AI_WORKER_PORT}:${AI_WORKER_PORT}"
      - "${AI_GRPC_PORT}:${AI_GRPC_PORT}"
    networks:
      - infra-net
      - ai-net
      - content-net
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      content-service:
        condition: service_healthy

  chatbot-service:
    build:
      context: ../../chatbot-service
      dockerfile: Dockerfile
    container_name: civic-chatbot-service
    restart: unless-stopped
    env_file: .env
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672/
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      PORT: ${CHATBOT_SERVICE_PORT}
    ports:
      - "${CHATBOT_SERVICE_PORT}:${CHATBOT_SERVICE_PORT}"
    networks:
      - infra-net
      - chatbot-net
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:${CHATBOT_SERVICE_PORT}/health')"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ═══════════════════════════════════════════════════════════════════════════
  # FRONTEND / GATEWAY
  # ═══════════════════════════════════════════════════════════════════════════

  admin-panel:
    build:
      context: ../../admin-panel
      dockerfile: Dockerfile
    container_name: civic-admin-panel
    restart: unless-stopped
    ports:
      - "${ADMIN_PANEL_PORT}:80"
    networks:
      - frontend-net
    depends_on:
      - admin-service
      - content-service
      - complaint-service

  nginx:
    image: nginx:alpine
    container_name: civic-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - frontend-net
      - admin-net
      - content-net
      - complaint-net
      - chatbot-net
      - ai-net
    depends_on:
      - admin-service
      - content-service
      - complaint-service
      - chatbot-service
      - admin-panel

# ═══════════════════════════════════════════════════════════════════════════
# NETWORKS – Each service gets isolated network + shared infra backbone
# ═══════════════════════════════════════════════════════════════════════════
networks:
  infra-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
          gateway: 172.28.0.1
  admin-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.1.0/24
          gateway: 172.28.1.1
  content-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.2.0/24
          gateway: 172.28.2.1
  complaint-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.3.0/24
          gateway: 172.28.3.1
  ai-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.4.0/24
          gateway: 172.28.4.1
  chatbot-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.5.0/24
          gateway: 172.28.5.1
  frontend-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.6.0/24
          gateway: 172.28.6.1

# ═══════════════════════════════════════════════════════════════════════════
# PERSISTENT VOLUMES
# ═══════════════════════════════════════════════════════════════════════════
volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  minio_data:
    driver: local
  redis_data:
    driver: local
