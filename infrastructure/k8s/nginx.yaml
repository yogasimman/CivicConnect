# =============================================================================
# Civic Connect – NGINX Reverse Proxy (K8s Deployment)
# =============================================================================
# Deploys our custom NGINX config as a pod. This handles all the complex
# URL rewriting that K8s Ingress annotations can't easily replicate.
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: civic-connect
data:
  nginx.conf: |
    worker_processes auto;
    events { worker_connections 1024; }

    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;

      log_format main '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'upstream=$upstream_addr';
      access_log /var/log/nginx/access.log main;
      error_log  /var/log/nginx/error.log warn;

      sendfile    on;
      tcp_nopush  on;
      keepalive_timeout 65;

      limit_req_zone $binary_remote_addr zone=api_limit:10m rate=60r/s;
      limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=15r/s;

      upstream admin_backend    { server admin-svc:8081; }
      upstream content_backend  { server content-svc:8082; }
      upstream complaint_backend { server complaint-svc:8083; }
      upstream chatbot_backend  { server chatbot-svc:8084; }
      upstream admin_panel      { server admin-panel-svc:80; }
      upstream minio_backend    { server minio-svc:9000; }

      server {
        listen 80;
        server_name localhost civic-connect.local;

        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        client_max_body_size 20M;

        # ── Uploaded Files (MinIO proxy) ───────────────────────────
        location /uploads/ {
          proxy_pass http://minio_backend/;
          proxy_set_header Host $host;
          proxy_hide_header x-amz-request-id;
          proxy_hide_header x-amz-id-2;
          expires 30d;
          add_header Cache-Control "public, immutable";
        }

        # ── Admin Panel (Vue SPA) ──────────────────────────────────
        location / {
          proxy_pass http://admin_panel;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ── Citizen Auth → admin-service root ──────────────────────
        location /api/v1/auth/ {
          limit_req zone=auth_limit burst=5 nodelay;
          proxy_pass http://admin_backend/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Authorization $http_authorization;
        }

        # ── Admin Portal → admin-service /api/admin/* ──────────────
        location /api/v1/admin/ {
          limit_req zone=api_limit burst=20 nodelay;
          proxy_pass http://admin_backend/api/admin/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Authorization $http_authorization;
        }

        # ── Content Service → content-service root ─────────────────
        location /api/v1/content/ {
          limit_req zone=api_limit burst=20 nodelay;
          proxy_pass http://content_backend/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Authorization $http_authorization;
        }

        # ── Complaint Service → complaint-service /complaints/* ────
        location /api/v1/complaints {
          limit_req zone=api_limit burst=20 nodelay;
          client_max_body_size 50M;
          proxy_pass http://complaint_backend/complaints;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Authorization $http_authorization;
        }

        # ── Local Governments (public) → admin-service ─────────────
        location /api/v1/governments/ {
          limit_req zone=api_limit burst=20 nodelay;
          proxy_pass http://admin_backend/localgovernments/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Authorization $http_authorization;
        }

        # ── Chatbot REST API ───────────────────────────────────────
        location /api/v1/chatbot/ {
          limit_req zone=api_limit burst=10 nodelay;
          proxy_pass http://chatbot_backend/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ── Chatbot WebSocket ──────────────────────────────────────
        location /ws/ {
          proxy_pass http://chatbot_backend;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_read_timeout 86400;
        }

        # ── Health Check ───────────────────────────────────────────
        location /nginx-health {
          access_log off;
          return 200 "OK\n";
          add_header Content-Type text/plain;
        }
      }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: civic-connect
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx-conf
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
          readinessProbe:
            httpGet:
              path: /nginx-health
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            requests:
              memory: "32Mi"
              cpu: "25m"
            limits:
              memory: "64Mi"
              cpu: "100m"
      volumes:
        - name: nginx-conf
          configMap:
            name: nginx-config

---
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  namespace: civic-connect
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30080
